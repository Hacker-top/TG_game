<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–û–¢ –ë–ê–Æ–ù: AI-–ü–ò–¢–û–ú–ï–¶-–•–£–ï–°–û–°</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* === –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è: TOXIC RETRO-GLITCH === */
        :root {
            --bg-deep: #0a0a0a;
            --bg-card: #181818;
            --text-light: #f0f0f0;
            --accent-main: #FF00FF; /* –Ø—Ä–∫–∏–π, –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –ø—É—Ä–ø—É—Ä–Ω—ã–π */
            --accent-alt: #00FFFF;  /* –ö–∏—Å–ª–æ—Ç–Ω—ã–π —Ü–∏–∞–Ω */
            --accent-red: #FF3333;
            --font-main: monospace, "Courier New", Courier;
            --border-radius-main: 6px;
        }
        body {
            font-family: var(--font-main);
            background-color: var(--bg-deep);
            color: var(--text-light);
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            touch-action: manipulation;
        }
        .container {
            width: 100%;
            max-width: 500px;
        }
        /* === –ê–ù–ò–ú–ê–¶–ò–Ø –ö–û–¢–ê === */
        #catDisplay {
            font-size: 130px;
            margin-bottom: 5px;
            line-height: 1;
            text-shadow: 0 0 5px var(--accent-main);
            transition: transform 0.1s, color 0.1s;
            cursor: pointer;
        }
        .mood-text {
            color: var(--accent-alt);
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 20px;
            text-shadow: 0 0 2px var(--accent-alt);
        }

        /* === –ö–ê–†–¢–û–ß–ö–ê –°–¢–ê–¢–£–°–ê (–£–•–û–î) === */
        .status-card {
            background: var(--bg-card);
            border: 1px solid var(--accent-main);
            padding: 15px;
            border-radius: var(--border-radius-main);
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.2);
        }
        .stats-grid {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        .stat-item {
            flex: 1;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
        }
        .stat-bar-bg {
            height: 8px;
            background: #333;
            border-radius: 2px;
            margin-top: 4px;
            overflow: hidden;
        }
        .stat-bar-fill {
            height: 100%;
            transition: width 0.3s ease-out, background-color 0.3s;
        }
        
        /* === –ë–õ–û–ö –î–ò–ê–õ–û–ì–ê (–ß–ò–°–¢–´–ô) === */
        #chatOutput {
            background: var(--bg-card);
            padding: 15px;
            border-left: 3px solid var(--accent-main);
            border-radius: var(--border-radius-main);
            margin-bottom: 20px;
            min-height: 80px;
            text-align: left;
            font-size: 15px;
            line-height: 1.4;
        }
        .message-status {
            color: var(--accent-alt);
            font-weight: 700;
            margin-right: 5px;
        }

        /* === –î–ï–ô–°–¢–í–ò–Ø –ò –ò–ù–ü–£–¢ === */
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .actions-grid button {
            padding: 10px;
            background: var(--bg-card);
            color: var(--text-light);
            border: 1px solid var(--accent-alt);
            border-radius: var(--border-radius-main);
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .actions-grid button:active {
            background: var(--accent-alt);
            color: var(--bg-deep);
        }
        
        /* –ß–ê–¢ */
        #textInput {
            flex-grow: 1;
            padding: 15px;
            border: 1px solid #333;
            border-radius: var(--border-radius-main);
            background: var(--input-bg);
            color: var(--text-light);
            font-size: 14px;
            outline: none;
            width: calc(100% - 30px);
            margin-bottom: 10px;
        }
        #sendButton {
            padding: 15px;
            background: var(--accent-main);
            color: var(--bg-deep);
            border: none;
            border-radius: var(--border-radius-main);
            font-weight: 900;
            cursor: pointer;
            transition: background-color 0.1s;
        }

        .function-buttons button {
            background: var(--bg-card);
            border: 1px solid #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="catDisplay" class="cat-emote">üòº</div>
        <div class="mood-text" id="catMoodDisplay">–Ø –í –ù–û–†–ú–ï, –ù–ï –î–û–ï–ë–´–í–ê–ô–°–Ø</div>

        <div class="status-card">
            <div class="stats-grid">
                <div class="stat-item">
                    –ì–û–õ–û–î<br>
                    <div class="stat-bar-bg">
                        <div id="hungerBar" class="stat-bar-fill" style="width: 100%; background-color: var(--accent-green);"></div>
                    </div>
                </div>
                <div class="stat-item">
                    –≠–ù–ï–†–ì–ò–Ø<br>
                    <div class="stat-bar-bg">
                        <div id="energyBar" class="stat-bar-fill" style="width: 100%; background-color: var(--accent-green);"></div>
                    </div>
                </div>
                <div class="stat-item">
                    –ù–ê–°–¢–†–û–ï–ù–ò–ï<br>
                    <div class="stat-bar-bg">
                        <div id="moodBar" class="stat-bar-fill" style="width: 100%; background-color: var(--accent-main);"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="actions-grid">
            <button id="feedBtn">–ü–û–ö–û–†–ú–ò–¢–¨ ü•©</button>
            <button id="playBtn">–ü–û–ò–ì–†–ê–¢–¨ üéæ</button>
            <button id="restBtn">–î–ê–¢–¨ –ü–û–°–ü–ê–¢–¨ üò¥</button>
        </div>

        <div id="chatOutput">
            <span class="message-status">–ö–û–¢ –ë–ê–Æ–ù:</span>
            –ü—Ä–∏–≤–µ—Ç, *–ª–æ—Ö*. –ì–æ—Ç–æ–≤ –∫ —Ç–æ–∫—Å–∏—á–Ω–æ–º—É –æ–±—â–µ–Ω–∏—é?
        </div>

        <input type="text" id="textInput" placeholder="–°–ø—Ä–æ—Å–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å, –µ—Å–ª–∏ —Å–º–µ–ª—ã–π...">
        <button id="sendButton">–°–ü–†–û–°–ò–¢–¨</button>

        <div class="function-buttons" style="margin-top: 15px;">
            <button id="insultBtn">–û–¶–ï–ù–ö–ê –£–°–ü–ï–®–ù–û–°–¢–ò</button>
            <button id="statusBtn">–ö–ê–ù–ê–õ–¨–ù–´–ô –ù–ê–î–ó–û–†</button>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web Apps
        const TWA = window.Telegram.WebApp;
        TWA.ready();
        TWA.expand(); 
        TWA.setHeaderColor('#0a0a0a'); 
        TWA.setBackgroundColor('#0a0a0a');

        // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –°–¢–ê–¢–£–° –ü–ò–¢–û–ú–¶–ê ===
        let userName = TWA.initDataUnsafe.user?.first_name || "–•–æ–∑—è–∏–Ω-–ë–æ–º–∂";
        let catName = "–ö–û–¢ –ë–ê–Æ–ù";
        const DECAY_RATE = 1000 * 60 * 5; // –£–ø–∞–¥–æ–∫ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
        
        // –í–ê–ñ–ù–û: URL –ë–≠–ö–ï–ù–î–ê (–ó–î–ï–°–¨ –ë–£–î–ï–¢ –í–ê–® –°–ï–†–í–ï–†)
        const BACKEND_URL = 'https://YOUR_ACTUAL_BACKEND_URL/api/chat'; 
        
        let petState = {
            hunger: 100,
            energy: 100,
            mood: 100,
            lastUpdate: Date.now()
        };

        // === DOM –≠–õ–ï–ú–ï–ù–¢–´ (—Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ) ===
        const catDisplay = document.getElementById('catDisplay');
        const catMoodDisplay = document.getElementById('catMoodDisplay');
        const chatOutput = document.getElementById('chatOutput');
        const textInput = document.getElementById('textInput');
        const sendButton = document.getElementById('sendButton');
        const bars = {
            hunger: document.getElementById('hungerBar'),
            energy: document.getElementById('energyBar'),
            mood: document.getElementById('moodBar')
        };
        const buttons = {
             feed: document.getElementById('feedBtn'),
             play: document.getElementById('playBtn'),
             rest: document.getElementById('restBtn'),
             insult: document.getElementById('insultBtn'),
             status: document.getElementById('statusBtn')
        };
        const catEmotes = { 
            default: 'üòº', bored: 'ü•±', thinking: 'üßê', angry: 'üò°', happy: 'üòª', fact: 'üñï', wise: 'ü§î', hungry: 'üòø', sleepy: 'üòæ'
        };

        // === –•–†–ê–ù–ï–ù–ò–ï –ò –°–¢–ê–¢–£–° ===
        const PET_STATE_KEY = 'pet_state_v7';
        const CAT_NAME_KEY = 'cat_bayun_name_v7';

        function loadState() {
            const savedState = localStorage.getItem(PET_STATE_KEY);
            const savedName = localStorage.getItem(CAT_NAME_KEY);
            if (savedState) petState = JSON.parse(savedState);
            if (savedName) catName = savedName;
            
            // –†–∞—Å—á–µ—Ç —É–ø–∞–¥–∫–∞ (Decay)
            const now = Date.now();
            const timeElapsed = now - petState.lastUpdate;
            const decayAmount = Math.floor(timeElapsed / DECAY_RATE);

            if (decayAmount > 0) {
                 petState.hunger = Math.max(0, petState.hunger - decayAmount * 10);
                 petState.energy = Math.max(0, petState.energy - decayAmount * 5);
                 petState.mood = Math.max(0, petState.mood - decayAmount * 8);
            }
            petState.lastUpdate = now;
            saveState();
        }

        function saveState() {
            localStorage.setItem(PET_STATE_KEY, JSON.stringify(petState));
            localStorage.setItem(CAT_NAME_KEY, catName);
        }

        function updateUI() {
            const getBarColor = (value) => {
                if (value > 70) return 'var(--accent-green)';
                if (value > 30) return 'var(--accent-main)';
                return 'var(--accent-red)';
            };

            for (const stat in bars) {
                const value = petState[stat];
                bars[stat].style.width = `${value}%`;
                bars[stat].style.backgroundColor = getBarColor(value);
            }

            let moodText = "–Ø –í –ù–û–†–ú–ï, –ù–ï –î–û–ï–ë–´–í–ê–ô–°–Ø";
            setCatEmote('default');

            if (petState.hunger < 30) { moodText = "–ë–õ–Ø–î–¨, –Ø –ì–û–õ–û–î–ï–ù, –ò–î–ò –ù–ê–•–£–ô! üòø"; setCatEmote('hungry'); }
            else if (petState.energy < 30) { moodText = "–Ø –£–°–¢–ê–õ, –°–£–ö–ê, –ù–ï –¢–†–û–ì–ê–ô –ú–ï–ù–Ø! üòæ"; setCatEmote('sleepy'); }
            else if (petState.mood < 30) { moodText = "–¢–´ –ú–ï–ù–Ø –ë–ï–°–ò–®–¨! –¢–´ –•–£–Å–í–´–ô –•–û–ó–Ø–ò–ù! üò°"; setCatEmote('angry'); }
            else if (petState.mood > 90) { moodText = "–ú–ù–ï –ù–û–†–ú. –°–ï–ì–û–î–ù–Ø –¢–´ –ú–ù–ï –ù–†–ê–í–ò–®–¨–°–Ø. üòª"; setCatEmote('happy'); }

            catMoodDisplay.textContent = moodText;
            catMoodDisplay.style.color = getBarColor(petState.mood); // –¶–≤–µ—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
        }
        
        function setCatEmote(emoteKey) {
            catDisplay.textContent = catEmotes[emoteKey] || catEmotes.default;
        }

        // === –ê–í–¢–û–†–°–ö–ò–ô –ö–û–î: –û–ë–©–ï–ù–ò–ï –ß–ï–†–ï–ó –ë–≠–ö–ï–ù–î ===
        async function getBackendResponse(userText) {
            // –ó–¥–µ—Å—å –º—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π AI-—Å–µ—Ä–≤–µ—Ä
            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: TWA.initDataUnsafe.user?.id || 'guest',
                        user_name: userName,
                        user_message: userText,
                        pet_state: petState
                    })
                });

                if (!response.ok) throw new Error("Backend error or bad status");

                const data = await response.json();
                
                // data.message - AI-–æ—Ç–≤–µ—Ç
                // data.pet_reaction - –Ω–æ–≤–∞—è —ç–º–æ—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                return data.message || "–û–®–ò–ë–ö–ê: –ë—ç–∫–µ–Ω–¥ –Ω–µ –≤–µ—Ä–Ω—É–ª –æ—Ç–≤–µ—Ç, –Ω–æ —è —Ç—É—Ç!";

            } catch (error) {
                // –ï—Å–ª–∏ –±—ç–∫–µ–Ω–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —à–∞–±–ª–æ–Ω–∞–º
                console.error("AI Backend failed, reverting to local templates:", error);
                
                // –í–ù–ò–ú–ê–ù–ò–ï: –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∞—à–∞ —Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ getResponse –∏–∑ V7.0!
                return "–°–ï–†–í–ï–† –°–ì–û–†–ï–õ, –ú–£–î–ò–õ–ê! –Ø –í–ï–†–ù–£–õ–°–Ø –ö –ü–†–ò–ú–ò–¢–ò–í–ù–´–ú –û–¢–í–ï–¢–ê–ú! (–ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å, –ª–æ—Ö)";
            }
        }

        async function handleSend() {
            const userText = textInput.value.trim();
            if (!userText) {
                TWA.HapticFeedback.notificationOccurred('error');
                setCatEmote('angry');
                chatOutput.innerHTML = `<span class="message-status">${catName}:</span> **–¢–´ –ó–ê–ë–´–õ –ù–ê–ü–ò–°–ê–¢–¨ –¢–ï–ö–°–¢, –ú–£–î–ò–õ–ê!**`;
                return;
            }

            chatOutput.innerHTML = `<span class="message-status">${userName} (–¢–´):</span> ${userText}<br>`;
            
            // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞
            sendButton.disabled = true;
            sendButton.textContent = '–î–£–ú–ê–ï–¢ AI...';
            textInput.disabled = true;
            setCatEmote('thinking');

            const response = await getBackendResponse(userText); // –ñ–¥—ë–º –æ—Ç–≤–µ—Ç –æ—Ç AI

            chatOutput.innerHTML += `<span class="message-status">${catName}:</span> ${response}`;

            // –°–±—Ä–æ—Å
            textInput.value = '';
            sendButton.disabled = false;
            sendButton.textContent = '–°–ü–†–û–°–ò–¢–¨';
            textInput.disabled = false;
            TWA.HapticFeedback.impactOccurred('light');
            updateUI();
        }

        // === –î–ï–ô–°–¢–í–ò–Ø –ü–û –£–•–û–î–£ (–û—Å—Ç–∞—é—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º–∏) ===
        function updateStat(stat, amount) {
            petState[stat] = Math.min(100, Math.max(0, petState[stat] + amount));
            petState.lastUpdate = Date.now(); 
            saveState();
            updateUI();
        }

        buttons.feed.addEventListener('click', () => { updateStat('hunger', 30); updateStat('mood', 15); updateStat('energy', -10); chatOutput.innerHTML = `<span class="message-status">${catName}:</span> **–ú–ù–ï –ù–û–†–ú!** –ê —Ç–µ–ø–µ—Ä—å –∏–¥–∏ –æ—Ç—Å—é–¥–∞.`; TWA.HapticFeedback.notificationOccurred('success'); });
        buttons.play.addEventListener('click', () => { if (petState.energy < 20) { chatOutput.innerHTML = `<span class="message-status">${catName}:</span> **–ù–ï–¢, –°–£–ö–ê!** –ò–¥–∏, –¥–∞–π –º–Ω–µ –ø–æ—Å–ø–∞—Ç—å.`; setCatEmote('sleepy'); TWA.HapticFeedback.notificationOccurred('error'); return;} updateStat('energy', -20); updateStat('mood', 30); updateStat('hunger', -10); chatOutput.innerHTML = `<span class="message-status">${catName}:</span> **–ú–Ø–£!** –Ø –¥–∞–∂–µ –ø–æ—á—Ç–∏ –ø–æ–ª—É—á–∏–ª —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ.`; TWA.HapticFeedback.notificationOccurred('success'); });
        buttons.rest.addEventListener('click', () => { updateStat('energy', 50); updateStat('mood', 10); chatOutput.innerHTML = `<span class="message-status">${catName}:</span> **–û–¢–í–ê–õ–ò!** –Ø —Å–ø–ª—é.`; TWA.HapticFeedback.notificationOccurred('success'); });
        
        buttons.insult.addEventListener('click', () => {
             updateStat('mood', -20);
             const insults = ["–¢–´ –ë–ï–°–ü–û–õ–ï–ó–ï–ù, –∫–∞–∫ –∫–Ω–æ–ø–∫–∞ '–û–±–Ω–æ–≤–∏—Ç—å' –Ω–∞ –±—É–º–∞–≥–µ.", "–¢–≤–æ–∏ —à–∞–Ω—Å—ã –Ω–∞ —É—Å–ø–µ—Ö –Ω–∏–∂–µ, —á–µ–º —É –∫–æ—Ç–∞ –≤ –∫–æ—Å–º–æ—Å–µ.", "–¢—ã ‚Äî –ø–æ–∑–æ—Ä–∏—â–µ, –∏ —ç—Ç–æ –Ω–µ –ª–µ—á–∏—Ç—Å—è."];
             const randomInsult = insults[Math.floor(Math.random() * insults.length)];
             chatOutput.innerHTML = `<span class="message-status">${catName}:</span> **–û–¶–ï–ù–ö–ê –£–°–ü–ï–®–ù–û–°–¢–ò:** ${randomInsult}`;
             TWA.HapticFeedback.notificationOccurred('error'); updateUI();
        });
        
        buttons.status.addEventListener('click', () => {
            TWA.showConfirm(`–ù—É —á—ë, ${userName}, —Ç—ã —Ç–∞–º –≤ –∫–∞–Ω–∞–ª–µ/—á–∞—Ç–µ —Å–≤–æ–µ–º —á—Ç–æ-–Ω–∏–±—É–¥—å —Å–¥–µ–ª–∞–ª?`, (confirmed) => {
                 updateStat('mood', -5);
                 if (confirmed) {
                    chatOutput.innerHTML = `<span class="message-status">${catName}:</span> –°–¥–µ–ª–∞–ª? **–í–†–Å–®–¨! –¢–´ –¢–ê–ú –ù–ò–•–£–Ø –ù–ï –î–ï–õ–ê–ï–®–¨!**`;
                    setCatEmote('angry');
                 } else {
                    chatOutput.innerHTML = `<span class="message-status">${catName}:</span> –ü—Ä–∏–∑–Ω–∞–ª—Å—è. **–•–û–¢–¨ –ß–ï–°–¢–ù–´–ô –î–ï–ë–ò–õ!** –ò–¥–∏ –¥–µ–ª–∞–π!`;
                    setCatEmote('fact');
                 }
                 updateUI();
            });
        });

        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
        function initializeApp() {
            loadState();
            updateUI(); 

            if (!localStorage.getItem(CAT_NAME_KEY)) {
                setTimeout(() => {
                    const newName = prompt("–≠–π, *–ª–æ—Ö*, —Ç—ã –∫—Ç–æ? –ü—Ä–∏–¥—É–º–∞–π –¥–ª—è –º–µ–Ω—è —É–≥–∞—Ä–Ω–æ–µ –∏–º—è:");
                    if (newName && newName.trim().length > 0) {
                        catName = newName.toUpperCase().trim();
                        saveState();
                    }
                    catMoodDisplay.textContent = `${catName} ‚Äî –¢–í–û–ô –¢–û–ö–°–ò–ß–ù–´–ô –ú–ï–ù–¢–û–†`;
                }, 500);
            } else {
                 catMoodDisplay.textContent = `${catName} ‚Äî –¢–í–û–ô –¢–û–ö–°–ò–ß–ù–´–ô –ú–ï–ù–¢–û–†`;
            }

            setInterval(updateUI, 5000); 
        }

        sendButton.addEventListener('click', handleSend);
        textInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSend(); });
        catDisplay.addEventListener('click', () => TWA.HapticFeedback.impactOccurred('medium'));

        initializeApp();
    </script>
</body>
</html>
